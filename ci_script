echo "$GERRIT_PROJECT"
echo "$GERRIT_BRANCH"

if [ -d "ghc-persistent-worker" ]; then
  rm -rf ghc-persistent-worker
fi

git clone ssh://jenkins@gerrit-server/ghc-persistent-worker

cd ghc-persistent-worker
git fetch origin refs/changes/$GERRIT_CHANGE_NUMBER/$GERRIT_CHANGE_NUMBER/$GERRIT_PATCHSET_NUMBER && git checkout FETCH_HEAD

/nix/var/nix/profiles/default/bin/nix-shell --run "cabal update"
/nix/var/nix/profiles/default/bin/nix-shell --run "cabal build buck-worker"

