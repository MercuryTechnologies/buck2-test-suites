echo "-*-*-*-*-*- NOW IN ci_script -*-*-*-*-*-"

echo "GERRIT_PROJECT = $GERRIT_PROJECT"
echo "GERRIT_BRANCH = $GERRIT_BRANCH"
echo "GERRIT_CHANGE_NUMBER = $GERRIT_CHANGE_NUMBER"
echo "GERRIT_PATCHSET_NUMBER = $GERRIT_PATCHSET_NUMBER"


function git_checkout {

  if [ -d "$1" ]; then
    rm -rf "$1"
  fi

  git clone "ssh://jenkins@gerrit-server/$1"

  if [ "$GERRIT_PROJECT" = "$1" ]; then
    cd "$1"
    git fetch origin refs/changes/${GERRIT_CHANGE_NUMBER: -2}/$GERRIT_CHANGE_NUMBER/$GERRIT_PATCHSET_NUMBER && git checkout FETCH_HEAD
    cd ..
  else
    cd "$1"
    git checkout "$2"
    cd ..
  fi
}

git_checkout ghc-persistent-worker experiments

git_checkout buck2 mercury

cd buck2
export CARGO_HOME=$PWD/.cargo
nix develop . --extra-experimental-features nix-command --extra-experimental-features flakes --command cargo install --path=app/buck2
cd ..

cd buck2-test-suites

git_checkout buck2-prelude mercury

$CARGO_HOME/bin/buck2 build //:test
cd ..

cd ghc-persistent-worker

export CABAL_DIR=$PWD/.cabal

nix-shell --run "cabal update"
nix-shell --run "cabal build buck-worker"
nix-shell --run "cabal build buck-multiplex-worker"
